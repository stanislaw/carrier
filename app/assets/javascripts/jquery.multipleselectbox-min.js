/*
 * jQuery Multiple Select Box Plugin 0.5.1
 * 
 * http://plugins.jquery.com/project/jquerymultipleselectbox
 * http://code.google.com/p/jquerymultipleselectbox/
 * 
 * Apache License 2.0
 * http://www.apache.org/licenses/LICENSE-2.0
 * 
 * @author dreamltf
 * @date 2011/03/06
 * 
 * Depends: jquery.js
 */
(function(h){var e="MultipleSelectBox";var d="disabled";var c="selected";var g="selecting";var b={maxLimit:-1,valueRendererArray:null,isMouseEventEnabled:true,isKeyEventEnabled:true,onSelectStart:null,onSelectEnd:null,onSelectChange:null};h.extend(h.fn,{multipleSelectBox:function(i){i=h.extend({},b,i);return this.each(function(){var j=h(this);j.addClass(e).data("options",i);j.css("MozUserSelect","none").bind("selectstart",function(){return false;});j.destroyMultipleSelectBox().recalculateMultipleSelectBox();if(i.onSelectStart){j.bind("onSelectStart",i.onSelectStart);}if(i.onSelectEnd){j.bind("onSelectEnd",i.onSelectEnd);}if(i.onSelectChange){j.bind("onSelectChange",i.onSelectChange);}f(j,i);});},getMultipleSelectBoxCachedRows:function(i){return this.pushStack(h.map(this,function(j){var l=h(j);var k=l.data("rows");if(i||!k){k=l.children("li");l.data("rows",k);}return k.get();}));},getMultipleSelectBoxRowIndex:function(){return this.data("index");},getMultipleSelectBoxOptions:function(){return this.data("options");},drawMultipleSelectBox:function(m,j,l,i,k,n){return this.each(function(){var y=h(this);var x=y.getMultipleSelectBoxCachedRows();var z=y.getMultipleSelectBoxOptions();if(!l){y.recalculateMultipleSelectBox(true,true);}var p=y.data("info");var o=m>j;if(m<0||j<0||z.maxLimit==0||x.eq(m).hasClass(d)){return this;}var t=Math.min(m,j);var r=Math.max(m,j);var v=[];var s=[];var q=0;x.each(function(A){var C=h(this);C.removeClass(g);if(!C.hasClass(d)){var B=C.hasClass(c);if(t<=A&&A<=r){if(B){if(i){v.push(C);}else{q++;}}else{s.push(C);}}else{if(B){if(k){q++;}else{v.push(C);}}}}});var u=s.length;if(z.maxLimit>0&&(u+q)>z.maxLimit){return this;}x.eq(j).addClass(g);for(var w in v){v[w].removeClass(c);}for(var w in s){s[w].addClass(c);}if(!n){y.scrollTop(o?p.rowInfoArray[j].topPos:p.rowInfoArray[j].bottomPos-p.height);}p.lastStartIndex=m;p.lastCurrentIndex=j;return this;});},serializeMultipleSelectBoxArray:function(){var i=this.getMultipleSelectBoxOptions();return h.map(this.getMultipleSelectBoxCachedRows(),function(m,j){var l=h(m);var k=null;if(!l.hasClass(d)&&l.hasClass(c)&&(i.valueRendererArray==null||(k=i.valueRendererArray[j])==null)){k=l.text();}return k;});},yieldMultipleSelectBox:function(){h(document).unbind("mouseleave."+e+" mousemove."+e);return this.unbind("mouseenter mouseleave mouseover");},destroyMultipleSelectBox:function(){return this.yieldMultipleSelectBox().each(function(){var j=h(this);j.unbind("mousedown onSelectStart onSelectEnd onSelectChange");var i=j.data("rows");if(i){i.removeData("index");}j.removeData("info").removeData("rows");});},recalculateMultipleSelectBox:function(k,i,l,j){return this.each(function(){var q=h(this);var n=q.getMultipleSelectBoxCachedRows(j);var m=q.data("info");if(!m){k=true;i=true;l=true;m={};q.data("info",m);}if(i){var p=[];var o=-1;n.each(function(r){var t=h(this);var s=t.offset().top;if(r==0){o=s;}s-=o;t.data("index",r);p.push({topPos:s,bottomPos:s+t.outerHeight()});});m.rowInfoArray=p;}if(k){m.topPos=q.offset().top;m.bottomPos=m.topPos+q.outerHeight();m.height=q.innerHeight();m.scrollHeight=this.scrollHeight;}if(l){m.lastStartIndex=-1;m.lastCurrentIndex=-1;m.prevStartIndex=-1;m.prevCurrentIndex=-1;}});}});function a(){return h("ul."+e).yieldMultipleSelectBox().each(function(){var k=h(this);var j=k.getMultipleSelectBoxOptions();var i=k.data("info");if(k.hasClass(g)&&(j.onSelectEnd||j.onSelectChange)){var l=[k.serializeMultipleSelectBoxArray(),i.lastStartIndex,i.lastCurrentIndex,i.prevStartIndex,i.prevCurrentIndex];if(j.onSelectEnd){k.trigger("onSelectEnd",l);}if(j.onSelectChange&&(l[0]!=l[2]||l[1]!=l[3])){k.trigger("onSelectChange",l);}}k.removeClass(g);i.prevStartIndex=i.lastStartIndex;i.prevCurrentIndex=i.lastCurrentIndex;});}function f(l,j){var i=l.getMultipleSelectBoxCachedRows();var k=i.length;if(j.isMouseEventEnabled){l.bind("mousedown",function(r){var n=h(r.target);if(this==n[0]){return true;}else{if(this!=n.parent()[0]){n=n.parents("ul."+e+">li").eq(0);}}l.recalculateMultipleSelectBox(true,true);var p=l.data("info");var s=n.getMultipleSelectBoxRowIndex();var o=s;var m=false;var q=false;if(j.isKeyEventEnabled){if(r.shiftKey){s=p.lastStartIndex;}else{if(r.ctrlKey){m=true;q=true;}}}l.addClass(g);l.drawMultipleSelectBox(s,o,true,m,q,true);l.bind("mouseenter",function(){h(document).unbind("mousemove."+e);}).bind("mouseleave",function(){h(document).bind("mousemove."+e,function(w){var t=w.pageY;if(t<p.topPos){if(o>0){var v=p.rowInfoArray[o].topPos-(p.topPos-t);if(v>0){for(var u=o-1;u>=0;u--){if(v>=p.rowInfoArray[u].topPos){o=u;break;}}}else{o=0;}l.drawMultipleSelectBox(s,o,true,false,q);}}else{if(t>p.bottomPos){if(o<k-1){var v=p.rowInfoArray[o].bottomPos+(t-p.bottomPos);if(v<p.scrollHeight){for(var u=o+1;u<k;u++){if(v<p.rowInfoArray[u].bottomPos){o=u;break;}}}else{o=k-1;}l.drawMultipleSelectBox(s,o,true,false,q);}}}});}).bind("mouseover",function(u){var t=h(u.target);if(this==t.parent()[0]){o=t.getMultipleSelectBoxRowIndex();l.drawMultipleSelectBox(s,o,true,false,q,true);}});if(h.browser.msie){h(document).bind("mouseleave."+e,function(){h(this).one("mousemove."+e,function(t){if(!t.button){a();}});});}if(j.onSelectStart){l.trigger("onSelectStart",[s]);}return false;});}return l;}h(document).bind("mouseup."+e,function(){a();});})(jQuery);